<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BotAlto – Telegram Bot Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/lucide@latest/font/lucide.min.css">
  <style>
    html,body{height:100%}
    body{font-family:'Google Sans',sans-serif;background:#f8f9fa;display:flex;flex-direction:column}
    main{flex:1}
    footer{background:#fff;border-top:1px solid #dee2e6;padding:.75rem 0;text-align:center;font-size:.875rem;color:#6c757d}
    .btn-lucide i{vertical-align:text-bottom;margin-right:.25rem}
    .card{transition:.2s}
    .card:hover{transform:translateY(-2px)}
    .toast-container{position:fixed;top:20px;right:20px;z-index:1100}
    #createBotModal .modal-body{padding:1.5rem}
  </style>
</head>
<body>
<main class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
      <h1 class="fw-bold mb-0">BotAlto</h1>
      <span class="badge bg-secondary ms-2 align-self-center">v1.0.0</span>
    </div>
    <button class="btn btn-primary btn-lucide" data-bs-toggle="modal" data-bs-target="#createBotModal">
      <i data-lucide="plus"></i>Create New Bot
    </button>
  </div>

  <!-- Create Bot Modal -->
  <div class="modal fade" id="createBotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Bot</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input id="newToken" class="form-control mb-3" placeholder="Bot Token">
          <input id="newName" class="form-control mb-3" placeholder="Bot Name">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createBot()">Create Bot</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast-container">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i data-lucide="check-circle" class="me-2"></i>
          <span id="toastMessage">Operation successful</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bots Dashboard -->
  <div id="dashboardSection">
    <h4 class="mb-3">Your Bots</h4>
    <div id="botsGrid" class="row g-3"></div>
  </div>

  <!-- Commands Dashboard -->
  <div id="commandsSection" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <button class="btn btn-outline-secondary btn-lucide" onclick="closeCommands()">
        <i data-lucide="arrow-left"></i>Back to Dashboard
      </button>
      <h4 class="mb-0">Commands for <span id="cmdBotName" class="badge bg-primary"></span></h4>
      <div></div> <!-- Empty div for flex spacing -->
    </div>

    <!-- Command Edit Section -->
    <div id="commandEditSection" class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span id="editSectionTitle">Add New Command</span>
        <button id="cancelEditBtn" class="btn btn-sm btn-outline-secondary" style="display:none" onclick="cancelEdit()">
          <i data-lucide="x" class="me-1"></i>Cancel
        </button>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Command name (without /)</label>
          <input id="cmdName" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Command code</label>
          <textarea id="cmdCode" class="form-control" rows="6" placeholder="ctx.reply('Hello');"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveCommand()">
          <i data-lucide="save" class="me-1"></i>Save Command
        </button>
      </div>
    </div>

    <!-- Command List -->
    <h5 class="mb-3">Existing Commands</h5>
    <div id="cmdGrid" class="row g-3"></div>
  </div>
</main>

<footer>
  <div>© <span id="year"></span> BotAlto – Open Source Telegram Bot Platform Server. Developed with ❤️ by Kaiiddo</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script>
// Initialize
lucide.createIcons();
document.getElementById('year').innerText = new Date().getFullYear();
const toast = new bootstrap.Toast(document.getElementById('successToast'));
let currentBotId = null;
let editingCommand = null;

// API helper
const api = (p,d) => fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).then(r=>r.json());

/* ---------- Toast Notifications ---------- */
function showToast(message) {
  document.getElementById('toastMessage').innerText = message;
  toast.show();
}

/* ---------- Bots Management ---------- */
async function loadBots() {
  try {
    const list = await fetch('/getBots').then(r=>r.json());
    const grid = document.getElementById('botsGrid');
    grid.innerHTML = '';
    
    if (list.length === 0) {
      grid.innerHTML = `
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-4">
              <i data-lucide="bot" class="text-muted mb-2" width="48" height="48"></i>
              <h5 class="text-muted">No bots created yet</h5>
              <p class="text-muted mb-0">Click "Create New Bot" to get started</p>
            </div>
          </div>
        </div>`;
      return;
    }

    list.forEach(b => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.innerHTML = `
        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <span>${b.name}</span>
            <span class="badge ${b.status==='RUN'?'bg-success':'bg-secondary'}">${b.status}</span>
          </div>
          <div class="card-body">
            <button class="btn btn-sm ${b.status==='RUN'?'btn-warning':'btn-success'} me-1" onclick="toggleBot('${b.botId}')">
              <i data-lucide="${b.status==='RUN'?'power-off':'play'}" class="me-1"></i>${b.status==='RUN'?'Stop':'Start'}
            </button>
            <button class="btn btn-sm btn-outline-info me-1" onclick="openCommands('${b.botId}','${b.name}')">
              <i data-lucide="terminal-square" class="me-1"></i>Commands
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteBot('${b.botId}')">
              <i data-lucide="trash-2" class="me-1"></i>Delete
            </button>
          </div>
        </div>`;
      grid.appendChild(col);
    });
    lucide.createIcons();
  } catch (error) {
    console.error('Error loading bots:', error);
    showToast('Error loading bots');
  }
}

async function createBot() {
  const token = document.getElementById('newToken').value.trim();
  const name = document.getElementById('newName').value.trim();
  
  if (!token || !name) {
    showToast('Please fill both fields');
    return;
  }

  try {
    await api('/createBot', {token, name});
    document.getElementById('newToken').value = '';
    document.getElementById('newName').value = '';
    bootstrap.Modal.getInstance(document.getElementById('createBotModal')).hide();
    showToast('Bot created successfully!');
    loadBots();
  } catch (error) {
    console.error('Error creating bot:', error);
    showToast('Error creating bot');
  }
}

async function toggleBot(id) {
  try {
    const bot = await fetch('/getBots').then(r=>r.json()).then(l=>l.find(b=>b.botId===id));
    const url = bot.status==='RUN'?'/stopBot':'/startBot';
    await api(url, {botId: id});
    showToast(`Bot ${bot.status==='RUN'?'stopped':'started'} successfully`);
    loadBots();
  } catch (error) {
    console.error('Error toggling bot:', error);
    showToast('Error toggling bot');
  }
}

async function deleteBot(id) {
  if (!confirm('Are you sure you want to delete this bot?')) return;
  
  try {
    await api('/deleteBot', {botId: id});
    showToast('Bot deleted successfully');
    loadBots();
  } catch (error) {
    console.error('Error deleting bot:', error);
    showToast('Error deleting bot');
  }
}

/* ---------- Commands Management ---------- */
async function openCommands(botId, name) {
  currentBotId = botId;
  document.getElementById('cmdBotName').innerText = name;
  document.getElementById('dashboardSection').style.display = 'none';
  document.getElementById('commandsSection').style.display = 'block';
  
  // Reset edit section
  document.getElementById('cmdName').value = '';
  document.getElementById('cmdCode').value = '';
  document.getElementById('editSectionTitle').innerText = 'Add New Command';
  document.getElementById('cancelEditBtn').style.display = 'none';
  editingCommand = null;
  
  await loadCommands();
}

function closeCommands() {
  document.getElementById('commandsSection').style.display = 'none';
  document.getElementById('dashboardSection').style.display = 'block';
}

async function loadCommands() {
  try {
    const cmds = await fetch(`/getCommands?botId=${currentBotId}`).then(r=>r.json());
    const grid = document.getElementById('cmdGrid');
    grid.innerHTML = '';
    
    if (Object.keys(cmds).length === 0) {
      grid.innerHTML = `
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-4">
              <i data-lucide="terminal-square" class="text-muted mb-2" width="48" height="48"></i>
              <h5 class="text-muted">No commands yet</h5>
              <p class="text-muted mb-0">Add your first command above</p>
            </div>
          </div>
        </div>`;
      return;
    }

    Object.entries(cmds).forEach(([name, code]) => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.innerHTML = `
        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <span>/${name}</span>
            <div>
              <button class="btn btn-sm btn-outline-secondary" onclick="editCmd('${name}',\`${escapeHtml(code)}\`)">
                <i data-lucide="edit-2" class="me-1"></i>Edit
              </button>
              <button class="btn btn-sm btn-outline-danger ms-1" onclick="delCmd('${name}')">
                <i data-lucide="trash-2" class="me-1"></i>Delete
              </button>
            </div>
          </div>
          <div class="card-body">
            <pre class="small bg-light p-2 rounded" style="max-height:120px;overflow:auto">${escapeHtml(code)}</pre>
          </div>
        </div>`;
      grid.appendChild(col);
    });
    lucide.createIcons();
  } catch (error) {
    console.error('Error loading commands:', error);
    showToast('Error loading commands');
  }
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function editCmd(name, code) {
  editingCommand = name;
  document.getElementById('cmdName').value = name;
  document.getElementById('cmdCode').value = code;
  document.getElementById('editSectionTitle').innerText = `Edit Command /${name}`;
  document.getElementById('cancelEditBtn').style.display = 'block';
  
  // Scroll to edit section
  document.getElementById('commandEditSection').scrollIntoView({ behavior: 'smooth' });
}

function cancelEdit() {
  editingCommand = null;
  document.getElementById('cmdName').value = '';
  document.getElementById('cmdCode').value = '';
  document.getElementById('editSectionTitle').innerText = 'Add New Command';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

async function saveCommand() {
  const name = document.getElementById('cmdName').value.trim();
  const code = document.getElementById('cmdCode').value.trim();
  
  if (!name || !code) {
    showToast('Please fill both fields');
    return;
  }

  try {
    if (editingCommand) {
      // If editing existing command, we might need to delete old one first if name changed
      if (name !== editingCommand) {
        await api('/delCommand', {botId: currentBotId, name: editingCommand});
      }
    }
    
    await api('/addCommand', {botId: currentBotId, name, code});
    showToast(`Command /${name} ${editingCommand ? 'updated' : 'added'} successfully`);
    
    // Reset form
    document.getElementById('cmdName').value = '';
    document.getElementById('cmdCode').value = '';
    document.getElementById('editSectionTitle').innerText = 'Add New Command';
    document.getElementById('cancelEditBtn').style.display = 'none';
    editingCommand = null;
    
    // Refresh command list
    await loadCommands();
  } catch (error) {
    console.error('Error saving command:', error);
    showToast('Error saving command');
  }
}

async function delCmd(name) {
  if (!confirm(`Are you sure you want to delete command /${name}?`)) return;
  
  try {
    await api('/delCommand', {botId: currentBotId, name});
    showToast(`Command /${name} deleted successfully`);
    
    // If we were editing this command, cancel edit
    if (editingCommand === name) {
      cancelEdit();
    }
    
    await loadCommands();
  } catch (error) {
    console.error('Error deleting command:', error);
    showToast('Error deleting command');
  }
}

// Initialize
loadBots();
</script>
</body>
</html>
